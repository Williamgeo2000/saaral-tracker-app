<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saaral Staff Payment Tracker</title>

    <!-- Apple-specific meta tags for Add to Home Screen -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Saaral Tracker">
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/007AFF/FFFFFF?text=SST">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for Inter font and rounded corners */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top */
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            background-color: #ffffff;
            border-radius: 12px; /* More rounded corners */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); /* Softer shadow */
            padding: 30px;
            width: 100%;
            max-width: 1200px; /* Max width for larger screens */
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .input-group label {
            font-weight: 500;
            color: #4b5563; /* Gray-700 */
            margin-bottom: 6px;
            display: block;
        }
        .input-group input[type="text"],
        .input-group input[type="date"],
        .input-group input[type="number"],
        .input-group input[type="tel"],
        .input-group select {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #d1d5db; /* Gray-300 */
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #3b82f6; /* Blue-500 */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .action-button {
            background-color: #10b981; /* Green-500 */
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3);
        }
        .action-button:hover {
            background-color: #059669; /* Green-600 */
            transform: translateY(-1px);
        }
        .action-button:active {
            transform: translateY(0);
        }
        .delete-button {
            background-color: #ef4444; /* Red-500 */
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.875rem;
            transition: background-color 0.2s ease-in-out;
        }
        .delete-button:hover {
            background-color: #dc2626; /* Red-600 */
        }
        .send-button {
            background-color: #3b82f6; /* Blue-500 */
            color: white;
            padding: 10px 18px;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .send-button:hover {
            background-color: #2563eb; /* Blue-600 */
        }
        .send-button:disabled {
            background-color: #9ca3af; /* Gray-400 */
            cursor: not-allowed;
        }
        table {
            border-collapse: separate;
            border-spacing: 0;
            overflow: hidden;
        }
        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #374151;
            text-transform: uppercase;
            font-size: 0.875rem;
        }
        tr:last-child td {
            border-bottom: none;
        }
        .table-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #333;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
        }
        .message-box.show {
            opacity: 1;
            pointer-events: auto;
        }
        .confirmation-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out;
        }
        .confirmation-dialog.show {
            opacity: 1;
            pointer-events: auto;
        }
        .confirmation-content {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        .confirmation-content h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 15px;
        }
        .confirmation-content p {
            color: #4b5563;
            margin-bottom: 25px;
        }
        .confirmation-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        .confirmation-buttons button {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .confirmation-buttons .confirm-yes {
            background-color: #ef4444;
            color: white;
        }
        .confirmation-buttons .confirm-yes:hover {
            background-color: #dc2626;
        }
        .confirmation-buttons .confirm-no {
            background-color: #e5e7eb;
            color: #4b5563;
        }
        .confirmation-buttons .confirm-no:hover {
            background-color: #d1d5db;
        }
        .report-summary-box {
            background-color: #e0f2fe;
            border: 1px solid #90cdf4;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 25px;
            text-align: center;
            display: flex; /* Use flexbox for horizontal layout */
            justify-content: space-around; /* Distribute items with space around them */
            flex-wrap: wrap; /* Allow items to wrap to the next line */
            gap: 10px; /* Space between items */
        }
        .report-summary-item { /* New class for individual summary items in report */
            flex: 1; /* Allow items to grow and shrink */
            min-width: 150px; /* Minimum width for each item */
            text-align: center;
        }
        .report-summary-item p {
            font-size: 1.0rem; /* Slightly smaller for multiple items */
            font-weight: 600;
            color: #2563eb;
            margin-bottom: 4px;
        }
        .report-summary-item span {
            font-size: 1.3rem; /* Slightly smaller for multiple items */
            font-weight: 700;
            color: #1d4ed8;
        }
        .total-summary-box {
            background-color: #d1fae5;
            border: 1px solid #34d399;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
            text-align: center;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
        }
        .total-summary-item {
            flex: 1;
            min-width: 200px;
        }
        .total-summary-item p {
            font-size: 1.25rem;
            font-weight: 600;
            color: #065f46;
            margin-bottom: 5px;
        }
        .total-summary-item span {
            font-size: 2rem;
            font-weight: 700;
            color: #047857;
        }
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000; /* Ensure it's on top */
            font-size: 1.5rem;
            font-weight: bold;
            color: #3b82f6;
        }
        #mainContent { /* Ensure main content is below overlay when hidden */
            z-index: 1;
        }
        #userIdDisplay {
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 15px;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div id="loadingOverlay">Loading...</div>

    <div class="container hidden" id="mainContent">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Saaral Staff Payment Tracker</h1>

        <!-- Tab Navigation Dropdown -->
        <div class="flex justify-center mb-6">
            <div class="input-group w-full max-w-xs">
                <label for="mainTabSelect" class="sr-only">Select Section</label>
                <select id="mainTabSelect" class="rounded-lg">
                    <option value="staffListTab">Staff List</option>
                    <option value="billDetailsTab" selected>Bill Details</option>
                    <option value="paymentHistoryTab">Payment History</option>
                    <option value="summaryTab">Per-Staff Summary</option>
                    <option value="reportTab">Report</option>
                    <option value="overallTotalsTab">Overall Totals</option>
                </select>
            </div>
        </div>

        <!-- Staff List Tab Content -->
        <div id="staffListTab" class="tab-content hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Add New Staff Member</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end mb-8">
                <div class="input-group">
                    <label for="newStaffName">Staff Name</label>
                    <input type="text" id="newStaffName" placeholder="e.g., Suresh" class="rounded-lg">
                </div>
                <div class="input-group">
                    <label for="newStaffMobile">Mobile Number</label>
                    <input type="tel" id="newStaffMobile" placeholder="e.g., 9876543210" class="rounded-lg">
                </div>
                <div class="md:col-span-2">
                    <button id="addStaffMemberBtn" class="action-button w-full">Add Staff</button>
                </div>
            </div>

            <h2 class="text-2xl font-semibold text-gray-700 mb-4">All Staff Members</h2>
            <div class="table-container">
                <table id="staffListTable" class="min-w-full bg-white rounded-lg shadow-sm">
                    <thead>
                        <tr>
                            <th class="rounded-tl-lg">Staff Name</th>
                            <th>Mobile Number</th>
                            <th class="rounded-tr-lg w-24">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Staff list will be rendered here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Bill Details Tab Content -->
        <div id="billDetailsTab" class="tab-content">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Add New Bill</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="input-group">
                    <label for="billStaffNameSelect">Staff Name</label>
                    <select id="billStaffNameSelect" class="rounded-lg">
                        <option value="">Select Staff</option>
                        <!-- Staff names will be populated here by JavaScript -->
                    </select>
                </div>
                <div class="input-group">
                    <label for="billDate">Bill Date</label>
                    <input type="date" id="billDate" class="rounded-lg">
                </div>
                <div class="input-group">
                    <label for="billNo">Bill No.</labeL>
                    <input type="text" id="billNo" placeholder="e.g., D001" class="rounded-lg">
                </div>
                <div class="input-group">
                    <label for="billAmount">Bill Amount (₹)</label>
                    <input type="number" id="billAmount" placeholder="e.g., 1500" class="rounded-lg">
                </div>
            </div>
            <button id="addBillBtn" class="action-button w-full mb-8">Add Bill</button>

            <h2 class="text-2xl font-semibold text-gray-700 mb-4">All Bills</h2>
            <div class="table-container">
                <table id="billDetailsTable" class="min-w-full bg-white rounded-lg shadow-sm">
                    <thead>
                        <tr>
                            <th class="rounded-tl-lg">Staff Name</th>
                            <th>Bill Date</th>
                            <th>Bill No.</th>
                            <th class="rounded-tr-lg">Bill Amount (₹)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Bill details will be rendered here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Payment History Tab Content -->
        <div id="paymentHistoryTab" class="tab-content hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Add New Payment</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="input-group">
                    <label for="paymentStaffNameSelect">Staff Name</label>
                    <select id="paymentStaffNameSelect" class="rounded-lg">
                        <option value="">Select Staff</option>
                        <!-- Staff names will be populated here by JavaScript -->
                    </select>
                </div>
                <div class="input-group">
                    <label for="paymentDate">Payment Date</label>
                    <input type="date" id="paymentDate" class="rounded-lg">
                </div>
                <div class="input-group">
                    <label for="amountPaid">Amount Paid (₹)</label>
                    <input type="number" id="amountPaid" placeholder="e.g., 1000" class="rounded-lg">
                </div>
            </div>
            <button id="addPaymentBtn" class="action-button w-full mb-8">Add Payment</button>

            <h2 class="text-2xl font-semibold text-gray-700 mb-4">All Payments</h2>
            <div class="table-container">
                <table id="paymentHistoryTable" class="min-w-full bg-white rounded-lg shadow-sm">
                    <thead>
                        <tr>
                            <th class="rounded-tl-lg">Staff Name</th>
                            <th>Payment Date</th>
                            <th class="rounded-tr-lg">Amount Paid (₹)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Payment history will be rendered here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Summary Tab Content (Per-Staff Summary) -->
        <div id="summaryTab" class="tab-content hidden">
            <h2 class="2xl font-semibold text-gray-700 mb-4">Per-Staff Summary</h2>
            <div class="table-container">
                <table id="summaryTable" class="min-w-full bg-white rounded-lg shadow-sm">
                    <thead>
                        <tr>
                            <th class="rounded-tl-lg">Staff Name</th>
                            <th>Total Bill (₹)</th>
                            <th>Total Paid (₹)</th>
                            <th class="rounded-tr-lg">Total Pending (₹)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Summary will be rendered here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Report Tab Content -->
        <div id="reportTab" class="tab-content hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Staff Report</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="input-group">
                    <label for="reportStaffNameSelect">Select Staff Member</label>
                    <select id="reportStaffNameSelect" class="rounded-lg">
                        <option value="">Select Staff</option>
                        <!-- Staff names will be populated here by JavaScript -->
                    </select>
                </div>
            </div>

            <div id="reportContent">
                <!-- New: Total Bill Amount and Total Paid Amount in Report Section -->
                <div class="report-summary-box">
                    <div class="report-summary-item">
                        <p>Total Bill Amount</p>
                        <span id="reportTotalBillValue">₹0.00</span>
                    </div>
                    <div class="report-summary-item">
                        <p>Total Paid Amount</p>
                        <span id="reportTotalPaidValue">₹0.00</span>
                    </div>
                    <div class="report-summary-item">
                        <p>Pending Amount</p>
                        <span id="pendingAmountValue">₹0.00</span>
                    </div>
                </div>

                <h3 class="text-xl font-semibold text-gray-700 mb-3 mt-6">Bills Taken</h3>
                <div class="table-container">
                    <table id="reportBillsTable" class="min-w-full bg-white rounded-lg shadow-sm">
                        <thead>
                            <tr>
                                <th class="rounded-tl-lg">Bill Date</th>
                                <th>Bill No.</th>
                                <th class="rounded-tr-lg">Bill Amount (₹)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="3" class="text-center text-gray-500">Select a staff member to view bills.</td></tr>
                        </tbody>
                    </table>
                </div>

                <h3 class="text-xl font-semibold text-gray-700 mb-3 mt-6">Payments Made</h3>
                <div class="table-container">
                    <table id="reportPaymentsTable" class="min-w-full bg-white rounded-lg shadow-sm">
                        <thead>
                            <tr>
                                <th class="rounded-tl-lg">Payment Date</th>
                                <th class="rounded-tr-lg">Amount Paid (₹)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="2" class="text-center text-gray-500">Select a staff member to view payments.</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="flex justify-center gap-4 mt-6">
                    <a id="smsButton" href="#" class="send-button" target="_blank" rel="noopener noreferrer" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                            <path d="M7.749 1.554a.75.75 0 0 0-1.498 0L3.872 6.73c.433.117.882.26 1.33.418.895.319 1.759.724 2.572 1.177l.16.096c.644.384 1.18.857 1.574 1.385.405.54.704 1.139.872 1.787.086.331.157.667.201 1.002a.75.75 0 0 0 1.499-.001 20.328 20.328 0 0 0-.21-1.206c-.161-.59-.405-1.144-.72-1.657-.367-.597-.843-1.134-1.403-1.588l-.16-.096a6.016 6.016 0 0 1-2.078-.975L7.749 1.554ZM10.32 8.79a.75.75 0 0 0-1.223.804c.047.073.1.147.159.22.251.307.545.617.876.924.33.307.69.597 1.07.86l.16.096c.405.242.775.457 1.109.64.32.175.61.32.86.43.209.096.39.16.54.195a.75.75 0 0 0 .285-1.472 4.498 4.498 0 0 0-.79-.176 5.003 5.003 0 0 1-.77-.36 6.016 6.016 0 0 1-1.403-.86l-.16-.096c-.38-.263-.74-.553-1.07-.86-.33-.307-.625-.617-.876-.924-.059-.073-.112-.147-.159-.22ZM13.68 15.21a.75.75 0 0 0 1.223-.804c-.047-.073-.1-.147-.159-.22-.251-.307-.545-.617-.876-.924-.33-.307-.69-.597-1.07-.86l-.16-.096a6.016 6.016 0 0 1-1.403-.86 5.003 5.003 0 0 1-.77-.36c-.209-.096-.39-.16-.54-.195a.75.75 0 0 0-.285 1.472 4.498 4.498 0 0 0 .79.176c.32.175.61.32.86.43.33.15.69.264 1.109.347l.16.096c.38.263.74.553 1.07.86.33.307.625.617.876.924.059.073.112.147.159.22Z" />
                            <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25ZM2.25 12c0 2.789 1.125 5.304 2.933 7.163l1.297-1.297a.75.75 0 0 1 1.06 0c.38.38.38 1.003 0 1.383l-1.44 1.439A9.75 9.75 0 0 0 12 21.75c2.789 0 5.304-1.125 7.163-2.933l-1.297-1.297a.75.75 0 0 1 0-1.06c.38-.38 1.003-.38 1.383 0l1.439 1.44A9.75 9.75 0 0 0 21.75 12c0-2.789-1.125-5.304-2.933-7.163l-1.297 1.297a.75.75 0 0 1-1.06 0c-.38.38-.38-1.003 0-1.383l1.439-1.44A9.75 9.75 0 0 0 12 2.25c-2.789 0-5.304 1.125-7.163 2.933l1.297 1.297a.75.75 0 0 1 0 1.06c-.38.38-.38-1.003 0-1.383l1.44 1.439A9.75 9.75 0 0 0 2.25 12Z" clip-rule="evenodd" />
                        </svg>
                        SMS வழியாக அனுப்பவும்
                    </a>
                    <a id="whatsappButton" href="#" class="send-button" target="_blank" rel="noopener noreferrer" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                            <path d="M12 0C5.373 0 0 5.373 0 12c0 2.067.534 4.02 1.5 5.72l-1.5 4.78 5-1.5c1.693.966 3.646 1.5 5.72 1.5 6.627 0 12-5.373 12-12S18.627 0 12 0zm0 2C17.522 2 22 6.478 22 12c0 5.523-4.478 10-10 10-1.993 0-3.86-.585-5.464-1.6L4 20l1.176-3.764c-1.026-1.604-1.6-3.471-1.6-5.464C3.522 6.478 8 2 12 2zm-2.25 5.5h-.5c-.276 0-.5.224-.5.5v2.5c0 .276.224.5.5.5h.5c.276 0 .5-.224.5-.5v-2.5c0-.276-.224-.5-.5-.5zm4.5 0h-.5c-.276 0-.5.224-.5.5v2.5c0 .276.224.5.5.5h.5c.276 0 .5-.224.5-.5v-2.5c0-.276-.224-.5-.5-.5zM12 11c-2.761 0-5 2.239-5 5s2.239 5 5 5 5-2.239 5-5-2.239-5-5-5zm0 1c2.209 0 4 1.791 4 4s-1.791 4-4 4-4-1.791-4-4 1.791-4 4-4zm-2 2h4v2h-4v-2z"/>
                        </svg>
                        WhatsApp வழியாக அனுப்பவும்
                    </a>
                </div>
            </div>
        </div>

        <!-- Overall Totals Tab Content -->
        <div id="overallTotalsTab" class="tab-content hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Overall Shop Totals</h2>
            <div class="total-summary-box">
                <div class="total-summary-item">
                    <p>Total Bill Amount</p>
                    <span id="overallTotalBill">₹0.00</span>
                </div>
                <div class="total-summary-item">
                    <p>Total Payment Received</p>
                    <span id="overallTotalPayment">₹0.00</span>
                </div>
                <div class="total-summary-item">
                    <p>Overall Pending</p>
                    <span id="overallTotalPending">₹0.00</span>
                </div>
            </div>
            <div id="userIdDisplay" class="text-center">
                <!-- User ID will be displayed here -->
            </div>
        </div>

    </div>

    <!-- Message Box for notifications -->
    <div id="messageBox" class="message-box"></div>

    <!-- Confirmation Dialog -->
    <div id="confirmationDialog" class="confirmation-dialog">
        <div class="confirmation-content">
            <h3 id="confirmationTitle">Confirm Deletion</h3>
            <p id="confirmationMessage">Are you sure you want to delete this item?</p>
            <div class="confirmation-buttons">
                <button class="confirm-yes" onclick="handleConfirmation(true)">Yes</button>
                <button class="confirm-no" onclick="handleConfirmation(false)">No</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query, where, writeBatch, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Configuration (moved outside function for clarity and global access)
        const firebaseConfig = {
            apiKey: "AIzaSyA3EbcGQBEnThwvTTKxHWVfwLdVWIj4_pc",
            authDomain: "saaraltrackerapp.firebaseapp.com",
            projectId: "saaraltrackerapp",
            storageBucket: "saaraltrackerapp.firebasestorage.app",
            messagingSenderId: "606630552381",
            appId: "1:606630552381:web:9d9caebd60a0c903825b54"
        };

        // Firebase variables - Declared globally (no 'let' here)
        let app;
        let db;
        let auth;
        // userId and appId are now global via window object
        window.userId = "my-saaral-tracker-admin"; // HARDCODED USER ID
        window.appId = firebaseConfig.projectId; // Use projectId from the config as appId

        // Data storage in memory (will be synced with Firestore)
        // Changed staffDetails to an array to support multiple staff with same name
        let staffDetails = []; // Now an array of { id, name, mobile }
        let billDetails = [];
        let paymentHistory = [];

        // Variable to store the callback for confirmation dialog
        let confirmationCallback = null;

        // Function to show messages to the user
        function showMessage(message, duration = 3000) {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.classList.add('show');
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, duration);
        }

        // Function to show a custom confirmation dialog
        function showConfirmation(title, message, callback) {
            const dialog = document.getElementById('confirmationDialog');
            document.getElementById('confirmationTitle').textContent = title;
            document.getElementById('confirmationMessage').textContent = message;
            confirmationCallback = callback; // Store the callback function
            dialog.classList.add('show');
        }

        // Function to handle confirmation dialog response
        window.handleConfirmation = function(confirmed) { // Made global
            const dialog = document.getElementById('confirmationDialog');
            dialog.classList.remove('show');
            if (confirmationCallback) {
                confirmationCallback(confirmed);
                confirmationCallback = null; // Clear the callback
            }
        }

        // --- Firestore Operations ---

        // Function to add a new staff member to Firestore
        window.addStaffMember = async function() { // Made global
            const newStaffNameInput = document.getElementById('newStaffName');
            const newStaffMobileInput = document.getElementById('newStaffMobile');
            const staffName = newStaffNameInput.value.trim();
            const mobileNumber = newStaffMobileInput.value.trim();

            if (!staffName) {
                showMessage('Please enter a staff name.');
                return;
            }
            if (!mobileNumber) {
                showMessage('Please enter a mobile number.');
                return;
            }
            if (!window.userId) { // Use window.userId
                showMessage('Authentication not ready. Please wait.');
                return;
            }

            // Check if staff with this mobile number already exists
            const existingStaff = staffDetails.find(s => s.mobile === mobileNumber);
            if (existingStaff) {
                showMessage(`Staff member with mobile number "${mobileNumber}" already exists.`);
                newStaffNameInput.value = '';
                newStaffMobileInput.value = '';
                return;
            }

            try {
                // Use addDoc to let Firestore generate a unique ID for the staff member
                const staffCollectionRef = collection(db, `artifacts/${window.appId}/users/${window.userId}/staff_members`);
                await addDoc(staffCollectionRef, {
                    name: staffName,
                    mobile: mobileNumber,
                    timestamp: new Date() // Add timestamp for sorting
                });
                newStaffNameInput.value = '';
                newStaffMobileInput.value = '';
                showMessage(`Staff "${staffName}" added to Firestore.`);
                // Data will be updated via onSnapshot listener
            } catch (e) {
                console.error("Error adding staff member: ", e);
                showMessage("Error adding staff member. Please try again.");
            }
        }

        // Function to delete a staff member from Firestore and related data
        window.deleteStaffMember = async function(staffIdToDelete) { // Now accepts staffId
            const staffMember = staffDetails.find(s => s.docId === staffIdToDelete);
            if (!staffMember) {
                showMessage('Staff member not found.');
                return;
            }

            showConfirmation(
                'Confirm Deletion',
                `Are you sure you want to delete staff member "${staffMember.name} (${staffMember.mobile})" and all their associated bills and payments? This action cannot be undone.`,
                async (confirmed) => {
                    if (confirmed) {
                        if (!window.userId) {
                            showMessage('Authentication not ready. Please wait.');
                            return;
                        }
                        try {
                            const batch = writeBatch(db);

                            // 1. Delete staff member document
                            const staffDocRef = doc(db, `artifacts/${window.appId}/users/${window.userId}/staff_members`, staffIdToDelete);
                            batch.delete(staffDocRef);

                            // 2. Delete associated bills
                            // Query by staffId, not staffName, for accuracy
                            const billsQuery = query(collection(db, `artifacts/${window.appId}/users/${window.userId}/bills`), where("staffId", "==", staffIdToDelete));
                            const billDocs = await getDocs(billsQuery);
                            billDocs.forEach((doc) => {
                                batch.delete(doc.ref);
                            });

                            // 3. Delete associated payments
                            // Query by staffId, not staffName, for accuracy
                            const paymentsQuery = query(collection(db, `artifacts/${window.appId}/users/${window.userId}/payments`), where("staffId", "==", staffIdToDelete));
                            const paymentDocs = await getDocs(paymentsQuery);
                            paymentDocs.forEach((doc) => {
                                batch.delete(doc.ref);
                            });

                            await batch.commit();
                            showMessage(`Staff member "${staffMember.name}" and all their data deleted successfully from Firestore.`);
                            // Data will be updated via onSnapshot listeners
                        } catch (e) {
                            console.error("Error deleting staff member and data: ", e);
                            showMessage("Error deleting staff member and data. Please try again.");
                        }
                    } else {
                        showMessage(`Deletion of "${staffMember.name}" cancelled.`);
                    }
                }
            );
        }

        // Function to add a new bill to Firestore
        window.addBill = async function() { // Made global
            const billStaffSelect = document.getElementById('billStaffNameSelect');
            const selectedStaffId = billStaffSelect.value; // Get the staffId from the dropdown
            const billDate = document.getElementById('billDate').value;
            const billNo = document.getElementById('billNo').value.trim();
            const billAmount = parseFloat(document.getElementById('billAmount').value);

            if (!selectedStaffId || selectedStaffId === "" || !billDate || !billNo || isNaN(billAmount) || billAmount <= 0) {
                showMessage('Please select a staff member and fill in all bill details correctly.');
                return;
            }
            if (!window.userId) {
                showMessage('Authentication not ready. Please wait.');
                return;
            }

            // Find the full staff details using the selectedStaffId
            const staff = staffDetails.find(s => s.docId === selectedStaffId);
            if (!staff) {
                showMessage('Selected staff member not found. Please re-select.');
                return;
            }

            try {
                const billsCollectionRef = collection(db, `artifacts/${window.appId}/users/${window.userId}/bills`);
                await addDoc(billsCollectionRef, { // Use addDoc for auto-ID
                    staffId: staff.docId, // Store unique staff ID
                    staffName: staff.name, // Store name for display/redundancy
                    staffMobile: staff.mobile, // Store mobile for display/redundancy
                    billDate: billDate,
                    billNo: billNo,
                    billAmount: billAmount,
                    timestamp: new Date()
                });

                billStaffSelect.value = '';
                document.getElementById('billDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('billNo').value = '';
                document.getElementById('billAmount').value = '';

                showMessage('Bill added successfully to Firestore!');
            } catch (e) {
                console.error("Error adding bill: ", e);
                showMessage("Error adding bill. Please try again.");
            }
        }

        // Function to add a new payment to Firestore
        window.addPayment = async function() { // Made global
            const paymentStaffSelect = document.getElementById('paymentStaffNameSelect');
            const selectedStaffId = paymentStaffSelect.value; // Get staffId from dropdown
            const paymentDate = document.getElementById('paymentDate').value;
            const amountPaid = parseFloat(document.getElementById('amountPaid').value);

            if (!selectedStaffId || selectedStaffId === "" || !paymentDate || isNaN(amountPaid) || amountPaid <= 0) {
                showMessage('Please select a staff member and fill in all payment details correctly.');
                return;
            }
            if (!window.userId) {
                showMessage('Authentication not ready. Please wait.');
                return;
            }

            // Find the full staff details using the selectedStaffId
            const staff = staffDetails.find(s => s.docId === selectedStaffId);
            if (!staff) {
                showMessage('Selected staff member not found. Please re-select.');
                return;
            }

            try {
                const paymentsCollectionRef = collection(db, `artifacts/${window.appId}/users/${window.userId}/payments`);
                await addDoc(paymentsCollectionRef, { // Use addDoc for auto-ID
                    staffId: staff.docId, // Store unique staff ID
                    staffName: staff.name, // Store name for display/redundancy
                    staffMobile: staff.mobile, // Store mobile for display/redundancy
                    paymentDate: paymentDate,
                    amountPaid: amountPaid,
                    timestamp: new Date()
                });

                paymentStaffSelect.value = '';
                document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('amountPaid').value = '';

                showMessage('Payment added successfully to Firestore!');
            } catch (e) {
                console.error("Error adding payment: ", e);
                showMessage("Error adding payment. Please try again.");
            }
        }

        // --- UI Rendering Functions (mostly unchanged, now driven by Firestore data) ---

        function renderBillDetailsTable() {
            const tableBody = document.getElementById('billDetailsTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';
            billDetails.forEach(bill => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = bill.staffName; // Display staffName
                row.insertCell().textContent = bill.billDate;
                row.insertCell().textContent = bill.billNo;
                row.insertCell().textContent = bill.billAmount.toFixed(2);
            });
        }

        function renderPaymentHistoryTable() {
            const tableBody = document.getElementById('paymentHistoryTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';
            paymentHistory.forEach(payment => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = payment.staffName; // Display staffName
                row.insertCell().textContent = payment.paymentDate;
                row.insertCell().textContent = payment.amountPaid.toFixed(2);
            });
        }

        function renderSummaryTable() {
            const tableBody = document.getElementById('summaryTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';

            const staffSummary = {}; // Object to hold summary data for each staff, keyed by staffId

            // Initialize summary for all known staff
            staffDetails.forEach(staff => {
                staffSummary[staff.docId] = {
                    name: staff.name,
                    mobile: staff.mobile,
                    totalBill: 0,
                    totalPaid: 0,
                    totalPending: 0
                };
            });

            billDetails.forEach(bill => {
                if (staffSummary[bill.staffId]) { // Ensure staff exists in summary
                    staffSummary[bill.staffId].totalBill += bill.billAmount;
                }
            });

            paymentHistory.forEach(payment => {
                if (staffSummary[payment.staffId]) { // Ensure staff exists in summary
                    staffSummary[payment.staffId].totalPaid += payment.amountPaid;
                }
            });

            // Iterate over sorted staffDetails to ensure all staff are displayed
            Array.from(staffDetails).sort((a, b) => a.name.localeCompare(b.name)).forEach(staff => {
                const summary = staffSummary[staff.docId];
                summary.totalPending = summary.totalBill - summary.totalPaid;

                const row = tableBody.insertRow();
                row.insertCell().textContent = `${summary.name}`; // Display ONLY name
                row.insertCell().textContent = summary.totalBill.toFixed(2);
                row.insertCell().textContent = summary.totalPaid.toFixed(2);
                row.insertCell().textContent = summary.totalPending.toFixed(2);
            });
        }

        function renderStaffListTable() {
            const tableBody = document.getElementById('staffListTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';

            // Sort staff by name for display
            Array.from(staffDetails).sort((a, b) => a.name.localeCompare(b.name)).forEach(staff => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = staff.name;
                row.insertCell().textContent = staff.mobile || 'N/A'; // Display mobile number
                const actionsCell = row.insertCell();
                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.classList.add('delete-button');
                deleteButton.onclick = () => deleteStaffMember(staff.docId); // Pass docId for deletion
                actionsCell.appendChild(deleteButton);
            });
        }

        function populateStaffDropdowns() {
            const billStaffSelect = document.getElementById('billStaffNameSelect');
            const paymentStaffSelect = document.getElementById('paymentStaffNameSelect');
            const reportStaffSelect = document.getElementById('reportStaffNameSelect');

            // Store current selected values (docId) to restore after repopulating
            const currentBillSelected = billStaffSelect.value;
            const currentPaymentSelected = paymentStaffSelect.value;
            const currentReportSelected = reportStaffSelect.value;

            // Clear existing options (except the default "Select Staff")
            billStaffSelect.innerHTML = '<option value="">Select Staff</option>';
            paymentStaffSelect.innerHTML = '<option value="">Select Staff</option>';
            reportStaffSelect.innerHTML = '<option value="">Select Staff</option>';

            const sortedStaff = Array.from(staffDetails).sort((a, b) => a.name.localeCompare(b.name));

            sortedStaff.forEach(staff => {
                // Display only name in dropdowns for Bill Details and Payment History
                const optionTextBasic = staff.name; 
                // Display only name in dropdown for Report section
                const optionTextReport = staff.name; // Changed to display ONLY name
                
                const option1 = document.createElement('option');
                option1.value = staff.docId; // Use docId as the value
                option1.textContent = optionTextBasic; // Only name
                billStaffSelect.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = staff.docId; // Use docId as the value
                option2.textContent = optionTextBasic; // Only name
                paymentStaffSelect.appendChild(option2);

                const option3 = document.createElement('option');
                option3.value = staff.docId; // Use docId as the value
                option3.textContent = optionTextReport; // Only name
                reportStaffSelect.appendChild(option3);
            });

            // Restore previously selected values if they still exist
            if (staffDetails.some(s => s.docId === currentBillSelected)) {
                billStaffSelect.value = currentBillSelected;
            }
            if (staffDetails.some(s => s.docId === currentPaymentSelected)) {
                paymentStaffSelect.value = currentPaymentSelected;
            }
            if (staffDetails.some(s => s.docId === currentReportSelected)) {
                reportStaffSelect.value = currentReportSelected;
            }
        }

        window.generateReport = function() { // Made global
            const selectedStaffId = document.getElementById('reportStaffNameSelect').value; // Get staffId
            const reportBillsTableBody = document.getElementById('reportBillsTable').getElementsByTagName('tbody')[0];
            const reportPaymentsTableBody = document.getElementById('reportPaymentsTable').getElementsByTagName('tbody')[0];
            const reportTotalBillValueSpan = document.getElementById('reportTotalBillValue');
            const reportTotalPaidValueSpan = document.getElementById('reportTotalPaidValue');
            const pendingAmountValueSpan = document.getElementById('pendingAmountValue');

            const smsButton = document.getElementById('smsButton');
            const whatsappButton = document.getElementById('whatsappButton');

            reportBillsTableBody.innerHTML = '';
            reportPaymentsTableBody.innerHTML = '';
            reportTotalBillValueSpan.textContent = '₹0.00';
            reportTotalPaidValueSpan.textContent = '₹0.00';
            pendingAmountValueSpan.textContent = '₹0.00';

            smsButton.setAttribute('disabled', 'true');
            whatsappButton.setAttribute('disabled', 'true');

            if (!selectedStaffId) {
                reportBillsTableBody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-500">Select a staff member to view bills.</td></tr>';
                reportPaymentsTableBody.innerHTML = '<tr><td colspan="2" class="text-center text-gray-500">Select a staff member to view payments.</td></tr>';
                return;
            }

            const selectedStaff = staffDetails.find(s => s.docId === selectedStaffId);
            if (!selectedStaff) {
                showMessage('Selected staff member not found for report.');
                return;
            }

            let totalBillForReport = 0;
            billDetails.filter(bill => bill.staffId === selectedStaffId).forEach(bill => { // Filter by staffId
                totalBillForReport += bill.billAmount;
            });

            let totalPaidForReport = 0;
            paymentHistory.filter(payment => payment.staffId === selectedStaffId).forEach(payment => { // Filter by staffId
                totalPaidForReport += payment.amountPaid;
            });

            const pendingAmountForReport = totalBillForReport - totalPaidForReport;

            reportTotalBillValueSpan.textContent = `₹${totalBillForReport.toFixed(2)}`;
            reportTotalPaidValueSpan.textContent = `₹${totalPaidForReport.toFixed(2)}`;
            pendingAmountValueSpan.textContent = `₹${pendingAmountForReport.toFixed(2)}`;

            const staffBills = billDetails.filter(bill => bill.staffId === selectedStaffId); // Filter by staffId
            if (staffBills.length > 0) {
                staffBills.sort((a, b) => new Date(a.billDate) - new Date(b.billDate)).forEach(bill => {
                    const row = reportBillsTableBody.insertRow();
                    row.insertCell().textContent = bill.billDate;
                    row.insertCell().textContent = bill.billNo;
                    row.insertCell().textContent = bill.billAmount.toFixed(2);
                });
            } else {
                reportBillsTableBody.innerHTML = `<tr><td colspan="3" class="text-center text-gray-500">No bills found for ${selectedStaff.name}.</td></tr>`;
            }

            const staffPayments = paymentHistory.filter(payment => payment.staffId === selectedStaffId); // Filter by staffId
            if (staffPayments.length > 0) {
                staffPayments.sort((a, b) => new Date(a.paymentDate) - new Date(b.paymentDate)).forEach(payment => {
                    const row = reportPaymentsTableBody.insertRow();
                    row.insertCell().textContent = payment.paymentDate;
                    row.insertCell().textContent = payment.amountPaid.toFixed(2);
                });
            } else {
                reportPaymentsTableBody.innerHTML = `<tr><td colspan="2" class="text-center text-gray-500">No payments found for ${selectedStaff.name}.</td></tr>`;
            }

            const staffMobile = selectedStaff.mobile; // Get mobile from staffDetails using staffId
            if (staffMobile) {
                const reportMessageEnglish = `Saaral Staff Report for ${selectedStaff.name}:\n` + // Removed mobile from here
                                           `Total Bill Amount: ₹${totalBillForReport.toFixed(2)}\n` +
                                           `Total Paid Amount: ₹${totalPaidForReport.toFixed(2)}\n` +
                                           `Pending Balance: ₹${pendingAmountForReport.toFixed(2)}\n\n` +
                                           `For full details, please contact me.`;

                smsButton.href = `sms:${staffMobile}?body=${encodeURIComponent(reportMessageEnglish)}`;
                whatsappButton.href = `https://wa.me/${staffMobile}?text=${encodeURIComponent(reportMessageEnglish)}`;
                smsButton.removeAttribute('disabled');
                whatsappButton.removeAttribute('disabled');
            } else {
                showMessage(`Mobile number not available for ${selectedStaff.name}. Cannot send report via SMS/WhatsApp.`);
            }
        }

        function renderOverallTotals() {
            let totalBillAmount = 0;
            billDetails.forEach(bill => {
                totalBillAmount += bill.billAmount;
            });

            let totalPaymentReceived = 0;
            paymentHistory.forEach(payment => {
                totalPaymentReceived += payment.amountPaid;
            });

            const overallPending = totalBillAmount - totalPaymentReceived;

            document.getElementById('overallTotalBill').textContent = `₹${totalBillAmount.toFixed(2)}`;
            document.getElementById('overallTotalPayment').textContent = `₹${totalPaymentReceived.toFixed(2)}`;
            document.getElementById('overallTotalPending').textContent = `₹${overallPending.toFixed(2)}`;
            
            // Update userId display
            const userIdDisplay = document.getElementById('userIdDisplay');
            if (userIdDisplay) {
                userIdDisplay.textContent = `User ID: ${window.userId || 'Not authenticated'}`; // Use window.userId
            }
        }

        function renderTables() {
            renderBillDetailsTable();
            renderPaymentHistoryTable();
            renderSummaryTable();
            renderStaffListTable();
            populateStaffDropdowns();
            renderOverallTotals(); // This will also update userIdDisplay
        }

        window.showTab = function(tabId) { // Made global
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            document.getElementById(tabId).classList.remove('hidden');
            const mainTabSelect = document.getElementById('mainTabSelect');
            if (mainTabSelect) {
                mainTabSelect.value = tabId;
            }

            // Call render functions for the newly shown tab
            // These calls ensure the content is refreshed when a tab is selected
            if (tabId === 'staffListTab') {
                renderStaffListTable();
            } else if (tabId === 'billDetailsTab') {
                renderBillDetailsTable();
            } else if (tabId === 'paymentHistoryTab') {
                renderPaymentHistoryTable();
            } else if (tabId === 'summaryTab') {
                renderSummaryTable();
            } else if (tabId === 'reportTab') {
                generateReport(); // This will also update dropdowns
            } else if (tabId === 'overallTotalsTab') {
                renderOverallTotals();
            }
            populateStaffDropdowns(); // Always ensure dropdowns are up-to-date when switching tabs
        }

        // --- Firebase Initialization and Data Loading ---

        async function initializeFirebaseAndLoadData() {
            console.log("Initializing Firebase and loading data...");
            const loadingOverlay = document.getElementById('loadingOverlay');
            const mainContent = document.getElementById('mainContent');

            // Set a timeout to hide loading overlay and show error if something goes wrong
            const loadingTimeout = setTimeout(() => {
                loadingOverlay.textContent = "Loading timed out. Check console for errors or refresh.";
                loadingOverlay.style.display = 'flex'; // Ensure it's visible if timeout occurs
                mainContent.classList.add('hidden'); // Ensure main content stays hidden
                console.error("Firebase initialization timed out.");
            }, 15000); // 15 seconds timeout

            try {
                // Firebase Configuration: Directly use the provided config
                const firebaseConfig = {
                    apiKey: "AIzaSyA3EbcGQBEnThwvTTKxHWVfwLdVWIj4_pc",
                    authDomain: "saaraltrackerapp.firebaseapp.com",
                    projectId: "saaraltrackerapp",
                    storageBucket: "saaraltrackerapp.firebasestorage.app",
                    messagingSenderId: "606630552381",
                    appId: "1:606630552381:web:9d9caebd60a0c903825b54"
                };
                console.log("Firebase Config:", firebaseConfig);

                // Check if firebaseConfig is valid before proceeding
                if (!firebaseConfig.apiKey || !firebaseConfig.authDomain || !firebaseConfig.projectId) {
                    console.error("Firebase config is incomplete or invalid. Cannot initialize Firebase.");
                    showMessage("App configuration missing or invalid. Please contact support.");
                    loadingOverlay.textContent = "Error: Invalid Config.";
                    clearTimeout(loadingTimeout); // Clear timeout as we have an immediate error
                    return;
                }

                // Initialize Firebase app directly here
                app = initializeApp(firebaseConfig);
                auth = getAuth(app); // Get auth instance from the initialized app
                db = getFirestore(app); // Get firestore instance from the initialized app
                console.log("Firebase app, auth, and db initialized.");

                // Authenticate user anonymously
                console.log("Attempting authentication...");
                try {
                    console.log("Signing in anonymously...");
                    await signInAnonymously(auth);
                    console.log("Anonymous sign-in attempted.");
                } catch (authError) {
                    console.error("Authentication failed: ", authError);
                    showMessage(`Authentication failed. Data will not persist. Error: ${authError.message}`);
                    loadingOverlay.textContent = `Authentication Failed: ${authError.code}`; // Show auth error code
                    clearTimeout(loadingTimeout); // Clear timeout as we have an immediate error
                    return; // Stop execution if authentication fails
                }

                // Listen for auth state changes to get userId
                // This listener ensures we only proceed once authentication is confirmed
                onAuthStateChanged(auth, (user) => {
                    clearTimeout(loadingTimeout); // Clear timeout once auth state is known
                    if (user) {
                        window.userId = "my-saaral-tracker-admin"; // HARDCODED USER ID for sync
                        console.log("Authenticated with userId:", window.userId);
                        // Once authenticated, start listening to Firestore collections
                        setupFirestoreListeners(); // This triggers data loading and rendering
                        // The overlay will be hidden and main content shown after initial data is rendered
                        // by the renderTables() call within setupFirestoreListeners.
                        console.log("App loaded and default tab shown.");
                        
                        // Explicitly hide loading overlay and show main content here
                        loadingOverlay.style.display = 'none'; // Use display: none for immediate hiding
                        mainContent.classList.remove('hidden'); // Ensure main content is visible
                        showTab('billDetailsTab'); // Show default tab after loading
                    } else {
                        window.userId = null; // Use window.userId
                        console.log("No user is signed in. Data will not persist.");
                        showMessage("Not authenticated. Data will not persist.");
                        loadingOverlay.textContent = "Authentication Failed.";
                        mainContent.classList.add('hidden'); // Keep main content hidden if not authenticated
                        loadingOverlay.style.display = 'flex'; // Ensure overlay is visible if auth fails
                    }
                });

            } catch (e) {
                console.error("Error during Firebase initialization or authentication setup: ", e);
                showMessage("Failed to initialize app. Please check console for errors.");
                loadingOverlay.textContent = "Error during startup.";
                clearTimeout(loadingTimeout); // Clear timeout on any caught error
            }
        }

        function setupFirestoreListeners() {
            if (!db || !window.userId) { // Use window.userId
                console.error("Firestore or userId not available for listeners. Cannot set up listeners.");
                showMessage("Database not ready. Data sync disabled.");
                return;
            }
            console.log("Setting up Firestore listeners for userId:", window.userId); // Use window.userId

            // Listener for Staff Members
            onSnapshot(collection(db, `artifacts/${window.appId}/users/${window.userId}/staff_members`), (snapshot) => { // Use window.appId, window.userId
                console.log("Staff members snapshot received.");
                staffDetails = []; // Clear existing staff details
                snapshot.forEach((doc) => {
                    staffDetails.push({ ...doc.data(), docId: doc.id }); // Store doc.id for unique identification
                });
                console.log("Staff details updated:", staffDetails);
                renderTables(); // Re-render all tables
                // The main content and loading overlay are handled in onAuthStateChanged
            }, (error) => {
                console.error("Error listening to staff_members: ", error);
                showMessage(`Error loading staff data: ${error.message}`);
                // If there's an error loading data, still allow main content to show error message
                document.getElementById('loadingOverlay').style.display = 'none';
                document.getElementById('mainContent').classList.remove('hidden');
            });

            // Listener for Bills
            onSnapshot(collection(db, `artifacts/${window.appId}/users/${window.userId}/bills`), (snapshot) => { // Use window.appId, window.userId
                console.log("Bills snapshot received.");
                billDetails = []; // Clear existing bills
                snapshot.forEach((doc) => {
                    billDetails.push({ ...doc.data(), docId: doc.id });
                });
                // Sort bills by date (and then timestamp if dates are same)
                billDetails.sort((a, b) => {
                    const dateA = new Date(a.billDate);
                    const dateB = new Date(b.billDate);
                    if (dateA - dateB !== 0) return dateA - dateB;
                    // Fallback to current timestamp if original timestamp is missing (e.g., old data)
                    const tsA = a.timestamp ? a.timestamp.toDate() : new Date();
                    const tsB = b.timestamp ? b.timestamp.toDate() : new Date();
                    return tsA - tsB;
                });
                console.log("Bill details updated:", billDetails);
                renderTables(); // Re-render all tables
            }, (error) => {
                console.error("Error listening to bills: ", error);
                showMessage(`Error loading bill data: ${error.message}`);
            });

            // Listener for Payments
            onSnapshot(collection(db, `artifacts/${window.appId}/users/${window.userId}/payments`), (snapshot) => { // Use window.appId, window.userId
                console.log("Payments snapshot received.");
                paymentHistory = []; // Clear existing payments
                snapshot.forEach((doc) => {
                    paymentHistory.push({ ...doc.data(), docId: doc.id });
                });
                // Sort payments by date (and then timestamp if dates are same)
                paymentHistory.sort((a, b) => {
                    const dateA = new Date(a.paymentDate);
                    const dateB = new Date(b.paymentDate);
                    if (dateA - dateB !== 0) return dateA - dateB;
                    // Fallback to current timestamp if original timestamp is missing (e.g., old data)
                    const tsA = a.timestamp ? a.timestamp.toDate() : new Date();
                    const tsB = b.timestamp ? b.timestamp.toDate() : new Date();
                    return tsA - tsB;
                });
                console.log("Payment history updated:", paymentHistory);
                renderTables(); // Re-render all tables
            }, (error) => {
                console.error("Error listening to payments: ", error);
                showMessage(`Error loading payment data: ${error.message}`);
            });
        }

        // Initial setup when the page loads
        window.onload = function() {
            // Set default date for date inputs to today's date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('billDate').value = today;
            document.getElementById('paymentDate').value = today;

            // Initialize Firebase and load data
            initializeFirebaseAndLoadData();

            // Attach event listeners for buttons and select dropdowns after DOM is loaded
            document.getElementById('mainTabSelect').addEventListener('change', function() {
                window.showTab(this.value);
            });
            document.getElementById('addStaffMemberBtn').addEventListener('click', window.addStaffMember);
            document.getElementById('addBillBtn').addEventListener('click', window.addBill);
            document.getElementById('addPaymentBtn').addEventListener('click', window.addPayment);
            document.getElementById('reportStaffNameSelect').addEventListener('change', window.generateReport);
        };
    </script>
</body>
</html>
